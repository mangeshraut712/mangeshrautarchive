name: 🚀 Deploy Portfolio with AI Integration

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# Sets permissions for GitHub Actions
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one deployment at a time
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4

    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: 📦 Install dependencies
      run: npm ci

    - name: 🔑 Configure API Keys for Production
      if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' }}
      env:
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
      run: |
        # Create production config with GitHub secrets properly embedded
        echo "// 🚀 PRODUCTION CONFIGURATION - Generated by GitHub Actions at $(date)" > js/config.local.js
        echo "// 🔐 Using GitHub Repository Secrets securely embedded" >> js/config.local.js
        echo "" >> js/config.local.js
        echo "export const localConfig = {" >> js/config.local.js
        echo "  // 🔥 Grok xAI - Latest AI Model" >> js/config.local.js
        echo "  grokEnabled: true," >> js/config.local.js
        echo "  grokApiKey: '$GROK_API_KEY'," >> js/config.local.js
        echo "" >> js/config.local.js
        echo "  // 🤖 Claude (Anthropic) - Fallback AI" >> js/config.local.js
        echo "  anthropicEnabled: true," >> js/config.local.js
        echo "  anthropicApiKey: '$ANTHROPIC_API_KEY'," >> js/config.local.js
        echo "" >> js/config.local.js
        echo "  // 📚 Other API configurations" >> js/config.local.js
        echo "  wikipediaEnabled: true," >> js/config.local.js
        echo "  duckduckgoEnabled: true," >> js/config.local.js
        echo "  stackoverflowEnabled: true," >> js/config.local.js
        echo "" >> js/config.local.js
        echo "  // 🔧 MCP Server integrations" >> js/config.local.js
        echo "  mcpEnabled: true," >> js/config.local.js
        echo "  perplexityEnabled: true," >> js/config.local.js
        echo "  githubEnabled: true" >> js/config.local.js
        echo "};" >> js/config.local.js
        echo "" >> js/config.local.js
        echo "// ✅ Production config loaded - API keys securely embedded in build" >> js/config.local.js

        # Show build info
        echo "🔑 Config file generated with embedded API keys"

    - name: 📋 Configure Perplexity MCP Server (Production Only)
      if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' }}
      run: |
        # Create Perplexity MCP configuration
        cat > perplexity-mcp.json << EOF
        {
          "mcpServers": {
            "pplx-server": {
              "command": "node",
              "args": ["/Users/mangeshraut/Documents/Cline/MCP/perplexity-server/src/index.ts"],
              "env": {
                "PERPLEXITY_API_KEY": "$PERPLEXITY_API_KEY"
              }
            }
          }
        }
        EOF
      env:
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}

    - name: 📊 Generate AI Status File (Production Only)
      if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' }}
      run: |
        # Determine actual AI service availability based on secrets
        GROK_AVAILABLE=${{ secrets.GROK_API_KEY != '' }}
        CLAUDE_AVAILABLE=${{ secrets.ANTHROPIC_API_KEY != '' }}
        PERPLEXITY_AVAILABLE=${{ secrets.PERPLEXITY_API_KEY != '' }}

        # Create dynamic status file based on available secrets
        mkdir -p api/ai
        cat > api/ai/status.json << EOF
        {
          "grok": {
            "enabled": true,
            "model": "grok-4-latest",
            "available": $GROK_AVAILABLE,
            "reason": "$([[ $GROK_AVAILABLE == "true" ]] && echo "API key configured" || echo "No API key configured")"
          },
          "claude": {
            "enabled": true,
            "model": "claude-3-sonnet-20240229",
            "available": $CLAUDE_AVAILABLE,
            "reason": "$([[ $CLAUDE_AVAILABLE == "true" ]] && echo "API key configured" || echo "No API key configured")"
          },
          "duckduckgo": {
            "available": true,
            "reason": "No API key required"
          },
          "wiki": {
            "available": true,
            "reason": "No API key required"
          },
          "stackOverflow": {
            "available": true,
            "reason": "No API key required"
          },
          "perplexity": {
            "available": $PERPLEXITY_AVAILABLE,
            "reason": "$([[ $PERPLEXITY_AVAILABLE == "true" ]] && echo "API key configured" || echo "No API key configured")"
          },
          "_metadata": {
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source": "GitHub Actions Build",
            "deployment_type": "GitHub Pages",
            "api_keys_configured": {
              "grok": $GROK_AVAILABLE,
              "claude": $CLAUDE_AVAILABLE,
              "perplexity": $PERPLEXITY_AVAILABLE
            }
          }
        }
        EOF

        # Show what was generated
        echo "🚀 AI Status File Generated:"
        cat api/ai/status.json

    - name: 🏗️ Build Portfolio
      run: npm run build
      env:
        NODE_ENV: production

    - name: 💾 Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: � Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
